# PII Detection Configuration
# Modify this file to add/remove entity types, change thresholds,
# or add custom recognizer patterns without changing Python code.

detection:
  language: "en"
  min_confidence_threshold: 0.4  # Presidio phone scores 0.4 base

# Terms that must NOT be flagged as PERSON by spaCy NER.
# Case-insensitive exact match. Add entries as false positives are discovered.
person_entity_denylist:
  # Business / contract terms
  - "Managed Site"
  - "Site Acceptance"
  - "Allocation Target"
  - "Technical Site"
  - "Commercial Operation"
  - "Force Majeure"
  - "Effective Date"
  - "Guaranteed Capacity"
  - "Commercial Operation Date"
  - "Site Acceptance Test"
  - "Force Majeure Event"
  # Site-associated terms frequently misidentified as PERSON
  - "Project Site"
  - "Generation Site"
  - "Facility Site"
  - "Construction Site"
  - "Solar Site"
  - "Wind Site"
  - "Battery Site"
  - "Substation Site"
  - "Interconnection Site"
  - "Delivery Site"
  - "Metering Site"
  # Geographic names misidentified as PERSON
  - "Sierra Leone"
  - "Freetown"
  - "Ivory Coast"
  - "Burkina Faso"
  - "Sri Lanka"
  - "Costa Rica"
  - "Puerto Rico"
  - "El Salvador"
  - "Trinidad"
  - "Tobago"

# Regex patterns for filtering PERSON false positives from spaCy NER.
# If a PERSON entity matches ANY pattern, it is dropped. Case-insensitive.
# Complements the static denylist above for scalable structural matching.
person_entity_deny_patterns:
  # Unambiguous contract suffixes — 1+ preceding word is enough
  - '\b\w+\s+(?:Date|Period|Test|Agreement|Certificate|Obligation|Requirement|Warranty|Guarantee|Condition|Termination|Payment|Schedule|Appendix|Annex|Notice|Amount|Dispute|Damages|Report|Site)\b'
  # Ambiguous suffixes — require 2+ preceding words to avoid filtering real names like "Michael Price"
  - '\b(?:\w+\s+){2,4}(?:Event|Capacity|Price|Rate|Fee|Charge|Limit|Factor|Index|Ratio)\b'
  # "X of Y" contract phrases
  - '\b[A-Z][a-z]+\s+of\s+[A-Z][a-z]+\b'

# Section-restricted entity types: only redact these in PII-heavy sections.
# High-confidence regex entities (EMAIL, PHONE, SSN, etc.) still redact everywhere.
section_restricted_entities:
  - PERSON
  - STREET_ADDRESS

# Regex patterns that identify PII-heavy sections (case-insensitive).
# NER-based entities are only redacted within these sections.
pii_sections:
  - '(?:^|\n)\s*(?:ARTICLE\s+[\dIVXLCDM]+[.:]?\s*)?(?:NOTICES?|NOTIFICATION)\b'
  - '(?:^|\n)\s*(?:IN WITNESS WHEREOF|EXECUTION|SIGNATURES?)\b'
  - '(?:^|\n)\s*(?:RECITALS?|WHEREAS|PREAMBLE)\b'
  - '(?:^|\n)\s*(?:SCHEDULES?|APPENDIX|ANNEX|EXHIBIT)\s'
  # Representative and contact sections often contain names
  - '(?:^|\n)\s*(?:Designated\s+)?Representative'
  - '(?:^|\n)\s*Notice\s+Address'
  # Signature blocks with common seal
  - '(?:^|\n)\s*(?:THE\s+)?COMMON\s+SEAL'

# Context triggers for PERSON entities within PII sections.
# Even inside a PII section, a PERSON entity must appear near a contextual
# trigger (e.g., "Name:", "Attention:", "By:") to be kept. This narrows
# detection from "anywhere in NOTICES" to "near name-related lines."
name_context_triggers:
  enabled: true
  lookbehind_chars: 300
  patterns:
    - 'Name\s*:'
    - 'name\s*:'
    - 'Attention\s*:'
    - 'Attn\.?\s*:'
    - 'Contact(?:\s+Person)?\s*:'
    - 'Representative\s*:'
    - 'If\s+to\s+(?:the\s+)?(?:Seller|Buyer|Company|Owner|Operator|Lender|Agent|Party)'
    - 'By\s*:'
    - 'Signed\s+by'
    - '[Ee]xecuted\s+by'
    - '[Ww]itnessed\s+by'
    - '\bbetween\b'
    - '\bBetween\b'
    - '\bBETWEEN\b'
    - '\bWHEREAS\b'
    - '\bMr\.\s'
    - '\bMrs\.\s'
    - '\bMs\.\s'
    - '\bDr\.\s'
    - '\(\s*"(?:the\s+)?(?:Seller|Buyer|Company|Owner|Operator|Lender|Agent|Party)"\s*\)'

# Regex patterns to find the DEFINITIONS section and extract defined terms.
# Extracted terms become a per-contract dynamic denylist for PERSON entities.
definitions_section:
  heading_pattern: '(?:^|\n)\s*(?:ARTICLE\s+[\dIVXLCDM]+[.:]?\s*)?(?:DEFINITIONS?|INTERPRETATION)\b'
  term_patterns:
    - '"([^"]{2,60})"\s+(?:means|shall mean|has the meaning|refers to|is defined|includes)'
    - "\u201c([^\u201d]{2,60})\u201d\\s+(?:means|shall mean|has the meaning|refers to|is defined|includes)"

standard_entities:
  - EMAIL_ADDRESS
  - PHONE_NUMBER
  - PERSON
  - US_SSN
  - CREDIT_CARD
  - ORGANIZATION
  # NOTE: LOCATION is intentionally excluded. Presidio's NER-based LOCATION
  # entity catches cities, states, and countries which provide useful context
  # for contract analysis. Instead, we use a custom STREET_ADDRESS recognizer
  # below to redact only street-level details (house numbers, street names, PO boxes).

custom_recognizers:
  - name: contract_id
    entity_type: CONTRACT_ID
    patterns:
      - name: contract_id_pattern
        regex: 'PPA-\d{4}-\d{6}'
        score: 0.9

  - name: street_address
    entity_type: STREET_ADDRESS
    patterns:
      # Matches "123 Main Street", "No.7 Wilkinson Road", "No 5 Siaka Stevens Street", etc.
      - name: numbered_street
        regex: '(?:No\.?\s*)?\d{1,6}[A-Za-z]?\s+[A-Za-z][A-Za-z\.\s]{0,30}\b(?:Street|St|Avenue|Ave|Boulevard|Blvd|Drive|Dr|Lane|Ln|Road|Rd|Court|Ct|Place|Pl|Way|Circle|Cir|Terrace|Ter|Trail|Trl|Parkway|Pkwy|Highway|Hwy|Loop|Square|Sq)\.?\b'
        score: 0.85
      # Matches "No.7, Wilkinson Road" (comma-separated variant)
      - name: no_prefix_street
        regex: 'No\.?\s*\d{1,6}[A-Za-z]?\s*,\s*[A-Za-z][A-Za-z\.\s]{0,30}\b(?:Street|St|Avenue|Ave|Boulevard|Blvd|Drive|Dr|Lane|Ln|Road|Rd|Court|Ct|Place|Pl|Way|Circle|Cir|Terrace|Ter|Trail|Trl|Parkway|Pkwy|Highway|Hwy|Loop|Square|Sq)\.?\b'
        score: 0.85
      # Matches "P.O. Box 1234", "PO Box 567", "P O Box 89"
      - name: po_box
        regex: 'P\.?\s?O\.?\s*Box\s+\d+'
        score: 0.9

  # --- Signature Block Names ---
  # Captures names in structured signature fields (including ALL-CAPS names)
  # These patterns use fixed-length lookbehinds where possible or match the
  # full structure. Presidio will redact the matched span.
  - name: signature_name
    entity_type: PERSON
    patterns:
      # "Name: John Smith" - fixed lookbehind for "Name: "
      # Character class includes digits (0-9) and hyphens for OCR-garbled names like "CHArONFSN 2AD"
      - name: name_field_lower
        regex: '(?<=Name: )[A-Za-z][A-Za-z0-9\s\.\''-]{2,40}?(?=\s*(?:Title|TITLE|Name|NAME|By|BY|\[|\n|$))'
        score: 0.95
      # "NAME: LOKECH KUMAR" - fixed lookbehind for "NAME: "
      - name: name_field_upper
        regex: '(?<=NAME: )[A-Za-z][A-Za-z0-9\s\.\''-]{2,40}?(?=\s*(?:Title|TITLE|Name|NAME|By|BY|\[|\n|$))'
        score: 0.95
      # "By: John Smith" - fixed lookbehind
      - name: by_field_lower
        regex: '(?<=By: )[A-Za-z][A-Za-z0-9\s\.\''-]{2,40}?(?=\s*(?:Title|TITLE|Name|NAME|Date|\n|$))'
        score: 0.90
      # "BY: JOHN SMITH" - fixed lookbehind
      - name: by_field_upper
        regex: '(?<=BY: )[A-Za-z][A-Za-z0-9\s\.\''-]{2,40}?(?=\s*(?:Title|TITLE|Name|NAME|Date|\n|$))'
        score: 0.90
      # "Signed by John Smith" - terminates at newline or common delimiters
      - name: signed_by
        regex: '(?<=Signed by )[A-Za-z][A-Za-z0-9\s\.\''-]{2,40}?(?=\s*[\n,;]|$)'
        score: 0.90
      # "signed by John Smith" (lowercase)
      - name: signed_by_lc
        regex: '(?<=signed by )[A-Za-z][A-Za-z0-9\s\.\''-]{2,40}?(?=\s*[\n,;]|$)'
        score: 0.90
      # "Executed by John Smith" - terminates at newline
      - name: executed_by
        regex: '(?<=Executed by )[A-Za-z][A-Za-z0-9\s\.\''-]{2,40}?(?=\s*[\n,;]|$)'
        score: 0.90
      # "executed by John Smith" (lowercase)
      - name: executed_by_lc
        regex: '(?<=executed by )[A-Za-z][A-Za-z0-9\s\.\''-]{2,40}?(?=\s*[\n,;]|$)'
        score: 0.90
      # "Witnessed by John Smith" - terminates at newline
      - name: witnessed_by
        regex: '(?<=Witnessed by )[A-Za-z][A-Za-z0-9\s\.\''-]{2,40}?(?=\s*[\n,;]|$)'
        score: 0.90
      # "witnessed by John Smith" (lowercase)
      - name: witnessed_by_lc
        regex: '(?<=witnessed by )[A-Za-z][A-Za-z0-9\s\.\''-]{2,40}?(?=\s*[\n,;]|$)'
        score: 0.90

  # --- Notice Address Section Names ---
  # Captures names in notice/contact sections
  # Character class includes digits (0-9) and hyphens for OCR-garbled names
  - name: notice_address_name
    entity_type: PERSON
    patterns:
      # "Attention: John Smith"
      - name: attention_field
        regex: '(?<=Attention: )[A-Za-z][A-Za-z0-9\s\.\''-]{2,40}?(?=\s*(?:\n|,|;|$))'
        score: 0.95
      # "ATTENTION: JOHN SMITH"
      - name: attention_field_upper
        regex: '(?<=ATTENTION: )[A-Za-z][A-Za-z0-9\s\.\''-]{2,40}?(?=\s*(?:\n|,|;|$))'
        score: 0.95
      # "Attn: John Smith"
      - name: attn_field
        regex: '(?<=Attn: )[A-Za-z][A-Za-z0-9\s\.\''-]{2,40}?(?=\s*(?:\n|,|;|$))'
        score: 0.95
      # "ATTN: JOHN SMITH"
      - name: attn_field_upper
        regex: '(?<=ATTN: )[A-Za-z][A-Za-z0-9\s\.\''-]{2,40}?(?=\s*(?:\n|,|;|$))'
        score: 0.95
      # "Contact: John Smith"
      - name: contact_field
        regex: '(?<=Contact: )[A-Za-z][A-Za-z0-9\s\.\''-]{2,40}?(?=\s*(?:\n|,|;|\(|$))'
        score: 0.90
      # "CONTACT: JOHN SMITH"
      - name: contact_field_upper
        regex: '(?<=CONTACT: )[A-Za-z][A-Za-z0-9\s\.\''-]{2,40}?(?=\s*(?:\n|,|;|\(|$))'
        score: 0.90

  # --- Designated Representative Section ---
  # Captures names with corporate titles in representative sections
  # Character class includes digits (0-9) and hyphens for OCR-garbled names
  - name: designated_rep
    entity_type: PERSON
    patterns:
      # "Chandresh Jagad (Director)" or "LOKECH KUMAR (Director)"
      # Name followed by corporate title in parentheses - handles ALL-CAPS
      - name: rep_with_title
        regex: '[A-Za-z][A-Za-z0-9\s\.\''-]{2,40}?(?=\s*\((?:Director|Secretary|Manager|CEO|CFO|President|Chairman|Representative|DIRECTOR|SECRETARY|MANAGER)\))'
        score: 0.95
      # "Mr. Matthew Tilleard" - with honorific (4-char fixed lookbehind)
      - name: rep_with_mr
        regex: '(?<=Mr\. )[A-Za-z][A-Za-z0-9\s\.\''-]{2,40}?(?=\s*\((?:Director|Secretary|Manager|CEO|CFO|President|Chairman|Representative|DIRECTOR|SECRETARY|MANAGER)\))'
        score: 0.95
      # "Mrs. Jane Smith" - with honorific (5-char fixed lookbehind)
      - name: rep_with_mrs
        regex: '(?<=Mrs\. )[A-Za-z][A-Za-z0-9\s\.\''-]{2,40}?(?=\s*\((?:Director|Secretary|Manager|CEO|CFO|President|Chairman|Representative|DIRECTOR|SECRETARY|MANAGER)\))'
        score: 0.95
      # "Ms. Jane Smith" - with honorific (4-char fixed lookbehind)
      - name: rep_with_ms
        regex: '(?<=Ms\. )[A-Za-z][A-Za-z0-9\s\.\''-]{2,40}?(?=\s*\((?:Director|Secretary|Manager|CEO|CFO|President|Chairman|Representative|DIRECTOR|SECRETARY|MANAGER)\))'
        score: 0.95
      # "Dr. John Smith" - with honorific (4-char fixed lookbehind)
      - name: rep_with_dr
        regex: '(?<=Dr\. )[A-Za-z][A-Za-z0-9\s\.\''-]{2,40}?(?=\s*\((?:Director|Secretary|Manager|CEO|CFO|President|Chairman|Representative|DIRECTOR|SECRETARY|MANAGER)\))'
        score: 0.95
      # "Representative: John Smith"
      - name: rep_label
        regex: '(?<=Representative: )[A-Za-z][A-Za-z0-9\s\.\''-]{2,40}?(?=\s*(?:\n|\(|$))'
        score: 0.90
      # "REPRESENTATIVE: JOHN SMITH"
      - name: rep_label_upper
        regex: '(?<=REPRESENTATIVE: )[A-Za-z][A-Za-z0-9\s\.\''-]{2,40}?(?=\s*(?:\n|\(|$))'
        score: 0.90

  # --- Title Field Names (captures name on same line) ---
  # Captures names adjacent to Title fields in signature blocks
  # These patterns look for 2-3 word names immediately before "Title:"
  # Uses [ ]+ (space only) instead of \s+ to avoid matching across newlines
  # Score is set high (0.95) to win overlap resolution vs spaCy NER
  - name: title_field_name
    entity_type: PERSON
    patterns:
      # Pattern: "JOHN SMITH Title: Director" - captures 2-word name
      - name: name_before_title_2word
        regex: '\b[A-Z][a-zA-Z\.\'']+[ ]+[A-Z][a-zA-Z\.\'']+(?=[ ]+(?:Title|TITLE)\s*:)'
        score: 0.95
      # Pattern: "JOHN MIDDLE SMITH Title: Director" - captures 3-word name
      - name: name_before_title_3word
        regex: '\b[A-Z][a-zA-Z\.\'']+[ ]+[A-Z][a-zA-Z\.\'']+[ ]+[A-Z][a-zA-Z\.\'']+(?=[ ]+(?:Title|TITLE)\s*:)'
        score: 0.95

anonymization:
  # "replace" = swap with placeholder, "redact" = remove entirely, "keep" = do not anonymize
  operators:
    EMAIL_ADDRESS:  { strategy: replace, placeholder: "<EMAIL_REDACTED>" }
    PHONE_NUMBER:   { strategy: replace, placeholder: "<PHONE_REDACTED>" }
    PERSON:         { strategy: replace, placeholder: "<NAME_REDACTED>" }
    US_SSN:         { strategy: redact }
    CREDIT_CARD:    { strategy: redact }
    CONTRACT_ID:    { strategy: replace, placeholder: "<CONTRACT_ID_REDACTED>" }
    STREET_ADDRESS: { strategy: replace, placeholder: "<ADDRESS_REDACTED>" }
    ORGANIZATION:   { strategy: keep }  # Kept for context

file_validation:
  max_file_size_mb: 10
  allowed_extensions:
    - .pdf
    - .docx
